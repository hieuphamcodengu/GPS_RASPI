<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"/>
  <title>Plant Disease Detection</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f9fafc;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
    }

    h2 {
      text-align: center;
      color: #1a73e8;
      margin-bottom: 20px;
    }

    /* Thanh n√∫t ƒëi·ªÅu khi·ªÉn tr√™n c√πng */
    .top-controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .top-controls button {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      color: white;
      transition: all 0.3s;
      font-weight: bold;
    }

    .btn-back {
      background-color: #607D8B;
    }

    .btn-back:hover {
      background-color: #455A64;
    }

    .btn-camera {
      background-color: #2196F3;
    }

    .btn-camera:hover {
      background-color: #1976D2;
    }

    .btn-camera.active {
      background-color: #FF5722;
    }

    .btn-detect {
      background-color: #4CAF50;
    }

    .btn-detect:hover {
      background-color: #388E3C;
    }

    .btn-detect.active {
      background-color: #FF5722;
    }

    /* Khu v·ª±c hi·ªÉn th·ªã video/camera */
    .video-container {
      width: 100%;
      max-width: 960px;
      margin: 0 auto;
      background: #000;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    #videoFeed {
      width: 100%;
      height: auto;
      display: block;
    }

    /* Th√¥ng tin th·ªëng k√™ */
    .stats-panel {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      margin-top: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .stats-panel h3 {
      color: #1a73e8;
      margin-top: 0;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }

    .stat-item:last-child {
      border-bottom: none;
    }

    .stat-label {
      font-weight: bold;
      color: #555;
    }

    .stat-value {
      color: #1a73e8;
      font-weight: bold;
    }

    @media (max-width: 768px) {
      .top-controls button {
        flex: 1 1 100%;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ÔøΩ H·ªá Th·ªëng Ph√°t Hi·ªán B·ªánh C√¢y</h2>

    <!-- Thanh ƒëi·ªÅu khi·ªÉn tr√™n c√πng -->
    <div class="top-controls">
      <button class="btn-back" onclick="goBack()">
        ‚¨ÖÔ∏è Tr·ªü v·ªÅ
      </button>
      <button class="btn-camera" id="btnCamera" onclick="toggleCamera()">
        üìπ Xem camera
      </button>
      <button class="btn-detect" id="btnDetect" onclick="toggleDetection()">
        üéØ Detect
      </button>
    </div>

    <!-- Khu v·ª±c hi·ªÉn th·ªã video -->
    <div class="video-container">
      <img id="videoFeed" src="" alt="Camera Feed" style="display:none;">
      <div style="color: white; text-align: center; padding: 100px 20px;">
        <h3>üì∑ Camera ch∆∞a ƒë∆∞·ª£c k√≠ch ho·∫°t</h3>
        <p>Nh·∫•n n√∫t "Xem camera" ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
      </div>
    </div>

    <!-- Th√¥ng tin th·ªëng k√™ -->
    <div class="stats-panel">
      <h3>üìä Th√¥ng tin h·ªá th·ªëng</h3>
      <div class="stat-item">
        <span class="stat-label">Tr·∫°ng th√°i:</span>
        <span class="stat-value" id="statusText">ƒêang ch·ªù...</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">FPS:</span>
        <span class="stat-value" id="fpsText">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">S·ªë c√¢y ph√°t hi·ªán:</span>
        <span class="stat-value" id="objectCount">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Th·ªùi gian x·ª≠ l√Ω:</span>
        <span class="stat-value" id="inferenceTime">0 ms</span>
      </div>
    </div>
    
    <!-- B·∫£ng ph√¢n lo·∫°i -->
    <div class="stats-panel" id="classificationPanel" style="display:none; margin-top: 20px;">
      <h3>üåø K·∫øt qu·∫£ ph√¢n lo·∫°i</h3>
      <div class="stat-item">
        <span class="stat-label" style="color: #f44336;">üî¥ C√¢y b·ªã b·ªánh:</span>
        <span class="stat-value" id="diseaseCount" style="color: #f44336;">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label" style="color: #4CAF50;">üü¢ C√¢y b√¨nh th∆∞·ªùng:</span>
        <span class="stat-value" id="healthyCount" style="color: #4CAF50;">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">T·ªïng c·ªông:</span>
        <span class="stat-value" id="totalCount">0</span>
      </div>
    </div>
  </div>

  <script>
    let cameraActive = false;
    let detectionActive = false;
    let statsInterval = null;

    // Quay l·∫°i trang ch·ªß
    function goBack() {
      // D·ª´ng camera tr∆∞·ªõc khi quay l·∫°i
      if (cameraActive) {
        fetch("/camera_stop", { method: "POST" })
          .then(() => {
            window.location.href = "/";
          });
      } else {
        window.location.href = "/";
      }
    }

    // B·∫≠t/t·∫Øt camera
    function toggleCamera() {
      const videoFeed = document.getElementById("videoFeed");
      const statusText = document.getElementById("statusText");
      const btnCamera = document.getElementById("btnCamera");
      
      if (!cameraActive) {
        // B·∫≠t camera
        btnCamera.disabled = true;
        btnCamera.textContent = "‚è≥ ƒêang kh·ªüi ƒë·ªông...";
        
        fetch("/camera_start", { method: "POST" })
          .then(r => {
            if (r.ok) {
              cameraActive = true;
              videoFeed.style.display = "block";
              videoFeed.src = "/video_feed?t=" + new Date().getTime();
              statusText.textContent = "Camera ƒëang ho·∫°t ƒë·ªông";
              btnCamera.textContent = "‚èπÔ∏è T·∫Øt camera";
              btnCamera.classList.add("active");
              btnCamera.disabled = false;
              
              // B·∫Øt ƒë·∫ßu c·∫≠p nh·∫≠t stats
              startStatsUpdate();
            } else {
              statusText.textContent = "L·ªói kh·ªüi ƒë·ªông camera!";
              btnCamera.textContent = "üìπ Xem camera";
              btnCamera.disabled = false;
            }
          })
          .catch(err => {
            console.error("Error starting camera:", err);
            statusText.textContent = "L·ªói k·∫øt n·ªëi camera!";
            btnCamera.textContent = "üìπ Xem camera";
            btnCamera.disabled = false;
          });
      } else {
        // T·∫Øt camera
        fetch("/camera_stop", { method: "POST" })
          .then(() => {
            cameraActive = false;
            detectionActive = false;
            videoFeed.style.display = "none";
            videoFeed.src = "";
            statusText.textContent = "Camera ƒë√£ t·∫Øt";
            btnCamera.textContent = "üìπ Xem camera";
            btnCamera.classList.remove("active");
            
            document.getElementById("btnDetect").classList.remove("active");
            document.getElementById("btnDetect").textContent = "üéØ Detect";
            
            // D·ª´ng c·∫≠p nh·∫≠t stats
            stopStatsUpdate();
            resetStats();
          })
          .catch(err => console.error("Error stopping camera:", err));
      }
    }

    // B·∫≠t/t·∫Øt detection
    function toggleDetection() {
      if (!cameraActive) {
        alert("‚ö†Ô∏è Vui l√≤ng b·∫≠t camera tr∆∞·ªõc!");
        return;
      }

      const btnDetect = document.getElementById("btnDetect");
      const statusText = document.getElementById("statusText");
      
      if (!detectionActive) {
        // B·∫≠t detection
        btnDetect.disabled = true;
        fetch("/start_detection", { method: "POST" })
          .then(r => r.text())
          .then(msg => {
            detectionActive = true;
            btnDetect.classList.add("active");
            btnDetect.textContent = "‚èπÔ∏è D·ª´ng Detect";
            statusText.textContent = "ƒêang ph√°t hi·ªán v·∫≠t th·ªÉ...";
            btnDetect.disabled = false;
            console.log("Detection started:", msg);
          })
          .catch(err => {
            console.error("Error starting detection:", err);
            statusText.textContent = "L·ªói kh·ªüi ƒë·ªông detection!";
            btnDetect.disabled = false;
          });
      } else {
        // T·∫Øt detection
        btnDetect.disabled = true;
        fetch("/stop_detection", { method: "POST" })
          .then(r => r.text())
          .then(msg => {
            detectionActive = false;
            btnDetect.classList.remove("active");
            btnDetect.textContent = "üéØ Detect";
            statusText.textContent = "Camera ƒëang ho·∫°t ƒë·ªông (No detection)";
            btnDetect.disabled = false;
            console.log("Detection stopped:", msg);
            
            // Reset stats khi d·ª´ng detection
            document.getElementById("objectCount").textContent = "0";
            document.getElementById("inferenceTime").textContent = "0 ms";
          })
          .catch(err => {
            console.error("Error stopping detection:", err);
            btnDetect.disabled = false;
          });
      }
    }

    // C·∫≠p nh·∫≠t th·ªëng k√™ t·ª´ server
    function updateStats() {
      if (cameraActive) {
        fetch("/detection_stats")
          .then(r => r.json())
          .then(data => {
            document.getElementById("fpsText").textContent = data.fps;
            if (detectionActive) {
              const plantCount = data.plants_detected || data.objects || 0;
              document.getElementById("objectCount").textContent = plantCount;
              document.getElementById("inferenceTime").textContent = data.inference_time + " ms";
              
              // Hi·ªÉn th·ªã panel ph√¢n lo·∫°i n·∫øu c√≥ detection
              if (plantCount > 0) {
                document.getElementById("classificationPanel").style.display = "block";
                // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng b·ªánh/b√¨nh th∆∞·ªùng n·∫øu server g·ª≠i
                document.getElementById("diseaseCount").textContent = data.disease_count || 0;
                document.getElementById("healthyCount").textContent = data.healthy_count || 0;
                document.getElementById("totalCount").textContent = plantCount;
              }
            }
          })
          .catch(err => console.error("Error fetching stats:", err));
      }
    }

    // B·∫Øt ƒë·∫ßu c·∫≠p nh·∫≠t stats
    function startStatsUpdate() {
      if (statsInterval === null) {
        statsInterval = setInterval(updateStats, 500);  // C·∫≠p nh·∫≠t m·ªói 0.5s
      }
    }

    // D·ª´ng c·∫≠p nh·∫≠t stats
    function stopStatsUpdate() {
      if (statsInterval !== null) {
        clearInterval(statsInterval);
        statsInterval = null;
      }
    }

    // Reset stats display
    function resetStats() {
      document.getElementById("fpsText").textContent = "0";
      document.getElementById("objectCount").textContent = "0";
      document.getElementById("inferenceTime").textContent = "0 ms";
      document.getElementById("classificationPanel").style.display = "none";
      document.getElementById("diseaseCount").textContent = "0";
      document.getElementById("healthyCount").textContent = "0";
      document.getElementById("totalCount").textContent = "0";
    }

    // Cleanup khi tho√°t trang
    window.addEventListener('beforeunload', function() {
      if (cameraActive) {
        fetch("/camera_stop", { method: "POST", keepalive: true });
      }
    });
  </script>
</body>
</html>
